---
layout: post
title: "HTTP compression med IIS på Windows Azure"
description: "Kort om varför jag startat en blogg och vad jag vill uppnå med den"
category: bloggen
tags: [iis, azure, prestanda]
---
{% include JB/setup %}

En viktig komponent för att maximera prestandan i en web-applikation är att minska mängden data som skickas mellan klient och server. Mindre data innebär mindre laddningstider och därmed snabbare respons.

Ett sätt att minska mängden data som skickas är att låta web-servern komprimera denna innan den skickas till klienten. Exakt hur detta görs varierar mellan olika web-servrar men möjligheten finns i regel.

Statisk och dynamisk kompression
De filer som skickas från en web-server till en klient kan delas in i statiska och dynamiska.
# Statiska filer. Filer som ser är lika i varje förfrågan som görs till en viss URL. Vanliga exempel är bilder, CSS-filer och javascript.
# Dynamiska filer. Filer där innehållet kan se olika ut i en viss URL. Vanliga exempel är svar från web-tjänster samt innehåll som genenerar dynamiskt på server-sidan (php, asp.NET etc.).

Statiska filer bör alltid komprimeras eftersom web-servern kan spara de komprimerade filerna och återanvända dessa vid framtida förfrågningar. Därmed blir jobbet att göra själva komprimeringen mycket litet i förhållande till resultatet. För dynamiska filer är valet inte lika självklart eftersom komprimeringen måste genomföras i samband med att varje förfrågan behandlas. Att komprimera dessa filer innebär alltså en tradeoff mellan den ökade CPU som krävs för komrimering och den minskade filstorlek som blir resultatet.

Aktivera komprimering i IIS 7 / 7.5
Standardinställningen i IIS är att statisk komprimering är aktiv medan dynamisk komprimering är inaktiv. För att aktivera dynamisk komprimering så lägg till följande i web.config för den site som inställningen ska gälla för:

bc.. puts <system.webServer>
puts	<urlCompression doDynamicCompression="true" />
puts </system.webServer>

Vilka filtyper som ska komprimeras är inte möjliga att styra i web.config. För att ändra detta krävs istället att applicationHost.config modifieras. Följande exempel visar en standarduppsättningen samt hur denna kan utökas med komprimering av JSON-filer:

bc.. puts <httpCompression directory="%SystemDrive%\inetpub\temp\IIS Temporary Compressed Files" minFileSizeForComp="2700">
puts	<scheme name="gzip" dll="%Windir%\system32\inetsrv\gzip.dll" />
puts		<dynamicTypes>
puts			<add mimeType="text/*" enabled="true" />
puts			<add mimeType="message/*" enabled="true" />
puts			<add mimeType="application/x-javascript" enabled="true" />
puts			<add mimeType="*/*" enabled="false" />
puts			<add mimeType="application/json" enabled="true" />
puts			<add mimeType="application/json; charset=utf-8" enabled="true" />
puts		</dynamicTypes>
puts		<staticTypes>
puts			<add mimeType="text/*" enabled="true" />
puts			<add mimeType="message/*" enabled="true" />
puts			<add mimeType="application/javascript" enabled="true" />
puts			<add mimeType="*/*" enabled="false" />
puts		</staticTypes>
puts	</httpCompression>

bc.. puts <httpCompression directory="%SystemDrive%\inetpub\temp\IIS Temporary Compressed Files" minFileSizeForComp="2700">
puts	<scheme name="gzip" dll="%Windir%\system32\inetsrv\gzip.dll" />
puts		<dynamicTypes>
puts			<add mimeType="text/*" enabled="true" />
puts			<add mimeType="message/*" enabled="true" />
puts			<add mimeType="application/x-javascript" enabled="true" />
puts			<add mimeType="*/*" enabled="false" />
puts		</dynamicTypes>
puts		<staticTypes>
puts			<add mimeType="text/*" enabled="true" />
puts			<add mimeType="message/*" enabled="true" />
puts			<add mimeType="application/javascript" enabled="true" />
puts			<add mimeType="*/*" enabled="false" />
puts		</staticTypes>
puts	</httpCompression>

%systemroot%\system32\inetsrv\appcmd.exe set config -section:system.webServer/httpCompression /+"dynamicTypes.[mimeType='application/json',enabled='True']" /commit:apphost
%systemroot%\system32\inetsrv\appcmd.exe set config -section:system.webServer/httpCompression /+"dynamicTypes.[mimeType='application/json; charset=utf-8',enabled='True']" /commit:apphost
%systemroot%\system32\inetsrv\appcmd.exe set config /section:urlCompression /doDynamicCompression:True

Starta upp webservrar på Windows Azure med kompression konfigurerad